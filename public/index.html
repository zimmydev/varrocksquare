<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <!-- Preload UI resources -->
        <link rel="preload" as="style" href="/fonts.css">
        <link rel="preload" as="image" href="/assets/images/logo.png">
        <link rel="preload" as="image" href="/assets/images/bg.png">
        <!-- Prefetch UI resources -->
        <link rel="prefetch" href="/assets/images/default-avatar.png">
        <link rel="prefetch" href="/assets/images/content-bg.png">
        <!-- Prefetch UI icon resources -->
        <link rel="prefetch" href="/assets/icons/icons8-mail-16.png">
        <link rel="prefetch" href="/assets/icons/icons8-espresso-cup-16.png">
        <link rel="prefetch" href="/assets/icons/icons8-ok-16.png">
        <link rel="prefetch" href="/assets/icons/icons8-cancel-16.png">
        <link rel="prefetch" href="/assets/icons/icons8-radio-on-24.png">
        <link rel="prefetch" href="/assets/icons/icons8-radio-off-24.png">
        <link rel="prefetch" href="/assets/icons/icons8-radio-focused-24.png">
        <!-- Resources -->
        <link rel="icon" href="/assets/images/favicon.png">
        <link rel="stylesheet" href="/fonts.css">
        <link rel="stylesheet" href="/spinner.css">
        <script src="main.js"></script>
    </head>
    <body>
        <div id="app"></div>
        <script src="debug.js"></script>
        <script>
            // Setup user caching
            const userKey = "vsq-user";

            // Setup app flags
            const flags = {
                size: [window.innerWidth, window.innerHeight],
                user: JSON.parse(localStorage.getItem(userKey))
            };

            console.log("Initializing elm app with flags:", flags);

            // Setup app
            const app = Elm.Main.init({
                node: document.getElementById("app"),
                flags: flags
            });

            /* Incoming ports */

            // Allow elm to cache a user in localStorage
            app.ports.storeUser.subscribe(function(user) {
                if (user === null) {
                    localStorage.removeItem(userKey);
                } else {
                    localStorage.setItem(userKey, JSON.stringify(user));
                }
                // Propogate the cache change back to the app, in a nonblocking fashion
                setTimeout(function() { app.ports.userChanged.send(user); }, 0);
            });

            /* Outgoing ports */

            // Allow changes to the cache across the browser to propogate to the app
            window.addEventListener("storage", function(event) {
                if (event.storageArea === "localStorage" && event.key === userKey) {
                    app.ports.userChanged.send(event.newValue);
                }
            }, false);
        </script>
    </body>
</html>
